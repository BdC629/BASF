(function(){CKEDITOR.plugins.add("undo",{lang:"af,ar,bg,bn,bs,ca,cs,cy,da,de,el,en,en-au,en-ca,en-gb,eo,es,et,eu,fa,fi,fo,fr,fr-ca,gl,gu,he,hi,hr,hu,id,is,it,ja,ka,km,ko,ku,lt,lv,mk,mn,ms,nb,nl,no,pl,pt,pt-br,ro,ru,si,sk,sl,sq,sr,sr-latn,sv,th,tr,ug,uk,vi,zh,zh-cn",icons:"redo,redo-rtl,undo,undo-rtl",hidpi:true,init:function(f){var i=f.undoManager=new c(f);var d=f.addCommand("undo",{exec:function(){if(i.undo()){f.selectionChange();this.fire("afterUndo")}},startDisabled:true,canUndo:false});var g=f.addCommand("redo",{exec:function(){if(i.redo()){f.selectionChange();this.fire("afterRedo")}},startDisabled:true,canUndo:false});f.setKeystroke([[CKEDITOR.CTRL+90,"undo"],[CKEDITOR.CTRL+89,"redo"],[CKEDITOR.CTRL+CKEDITOR.SHIFT+90,"redo"]]);i.onChange=function(){d.setState(i.undoable()?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED);g.setState(i.redoable()?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED)};function h(j){if(i.enabled&&j.data.command.canUndo!==false){i.save()}}f.on("beforeCommandExec",h);f.on("afterCommandExec",h);f.on("saveSnapshot",function(j){i.save(j.data&&j.data.contentOnly)});f.on("contentDom",function(){f.editable().on("keydown",function(j){var k=j.data.getKey();if(k==8||k==46){i.type(k,0)}});f.editable().on("keypress",function(j){i.type(j.data.getKey(),1)})});f.on("beforeModeUnload",function(){f.mode=="wysiwyg"&&i.save(true)});function e(){i.enabled=f.readOnly?false:f.mode=="wysiwyg";i.onChange()}f.on("mode",e);f.on("readOnly",e);if(f.ui.addButton){f.ui.addButton("Undo",{label:f.lang.undo.undo,command:"undo",toolbar:"undo,10"});f.ui.addButton("Redo",{label:f.lang.undo.redo,command:"redo",toolbar:"undo,20"})}f.resetUndo=function(){i.reset();f.fire("saveSnapshot")};f.on("updateSnapshot",function(){if(i.currentImage){i.update()}});f.on("lockSnapshot",function(j){i.lock(j.data&&j.data.dontUpdate)});f.on("unlockSnapshot",i.unlock,i)}});CKEDITOR.plugins.undo={};var a=CKEDITOR.plugins.undo.Image=function(e,g){this.editor=e;e.fire("beforeUndoImage");var f=e.getSnapshot();if(CKEDITOR.env.ie&&f){f=f.replace(/\s+data-cke-expando=".*?"/g,"")}this.contents=f;if(!g){var d=f&&e.getSelection();this.bookmarks=d&&d.createBookmarks2(true)}e.fire("afterUndoImage")};var b=/\b(?:href|src|name)="[^"]*?"/gi;a.prototype={equalsContent:function(e){var d=this.contents,f=e.contents;if(CKEDITOR.env.ie&&(CKEDITOR.env.ie7Compat||CKEDITOR.env.ie6Compat)){d=d.replace(b,"");f=f.replace(b,"")}if(d!=f){return false}return true},equalsSelection:function(h){var f=this.bookmarks,e=h.bookmarks;if(f||e){if(!f||!e||f.length!=e.length){return false}for(var g=0;g<f.length;g++){var d=f[g],j=e[g];if(d.startOffset!=j.startOffset||d.endOffset!=j.endOffset||!CKEDITOR.tools.arrayCompare(d.start,j.start)||!CKEDITOR.tools.arrayCompare(d.end,j.end)){return false}}}return true}};function c(d){this.editor=d;this.reset()}c.prototype={type:function(i,d){var h=!d&&i!=this.lastKeystroke;var j=!this.typing||d&&!this.wasCharacter;var g=this.editor;if(j||h){var f=new a(g),e=this.snapshots.length;CKEDITOR.tools.setTimeout(function(){var k=g.getSnapshot();if(CKEDITOR.env.ie){k=k.replace(/\s+data-cke-expando=".*?"/g,"")}if(f.contents!=k&&e==this.snapshots.length){this.typing=true;if(!this.save(false,f,false)){this.snapshots.splice(this.index+1,this.snapshots.length-this.index-1)}this.hasUndo=true;this.hasRedo=false;this.typesCount=1;this.modifiersCount=1;this.onChange()}},0,this)}this.lastKeystroke=i;this.wasCharacter=d;if(!d){this.typesCount=0;this.modifiersCount++;if(this.modifiersCount>25){this.save(false,null,false);this.modifiersCount=1}else{setTimeout(function(){g.fire("change")},0)}}else{this.modifiersCount=0;this.typesCount++;if(this.typesCount>25){this.save(false,null,false);this.typesCount=1}else{setTimeout(function(){g.fire("change")},0)}}},reset:function(){this.lastKeystroke=0;this.snapshots=[];this.index=-1;this.limit=this.editor.config.undoStackSize||20;this.currentImage=null;this.hasUndo=false;this.hasRedo=false;this.locked=null;this.resetType()},resetType:function(){this.typing=false;delete this.lastKeystroke;this.typesCount=0;this.modifiersCount=0},fireChange:function(){this.hasUndo=!!this.getNextImage(true);this.hasRedo=!!this.getNextImage(false);this.resetType();this.onChange()},save:function(d,f,g){if(this.locked){return false}var e=this.snapshots;if(!f){f=new a(this.editor)}if(f.contents===false){return false}if(this.currentImage){if(f.equalsContent(this.currentImage)){if(d){return false}if(f.equalsSelection(this.currentImage)){return false}}else{this.editor.fire("change")}}e.splice(this.index+1,e.length-this.index-1);if(e.length==this.limit){e.shift()}this.index=e.push(f)-1;this.currentImage=f;if(g!==false){this.fireChange()}return true},restoreImage:function(f){var d=this.editor,e;if(f.bookmarks){d.focus();e=d.getSelection()}this.locked=1;this.editor.loadSnapshot(f.contents);if(f.bookmarks){e.selectBookmarks(f.bookmarks)}else{if(CKEDITOR.env.ie){var g=this.editor.document.getBody().$.createTextRange();g.collapse(true);g.select()}}this.locked=0;this.index=f.index;this.currentImage=this.snapshots[this.index];this.update();this.fireChange();d.fire("change")},getNextImage:function(d){var g=this.snapshots,f=this.currentImage,h,e;if(f){if(d){for(e=this.index-1;e>=0;e--){h=g[e];if(!f.equalsContent(h)){h.index=e;return h}}}else{for(e=this.index+1;e<g.length;e++){h=g[e];if(!f.equalsContent(h)){h.index=e;return h}}}}return null},redoable:function(){return this.enabled&&this.hasRedo},undoable:function(){return this.enabled&&this.hasUndo},undo:function(){if(this.undoable()){this.save(true);var d=this.getNextImage(true);if(d){return this.restoreImage(d),true}}return false},redo:function(){if(this.redoable()){this.save(true);if(this.redoable()){var d=this.getNextImage(false);if(d){return this.restoreImage(d),true}}}return false},update:function(f){if(this.locked){return}if(!f){f=new a(this.editor)}var d=this.index,e=this.snapshots;while(d>0&&this.currentImage.equalsContent(e[d-1])){d-=1}e.splice(d,this.index-d+1,f);this.index=d;this.currentImage=f},lock:function(e){if(!this.locked){if(e){this.locked={level:1}}else{var f=new a(this.editor,true);var d=this.currentImage&&this.currentImage.equalsContent(f);this.locked={update:d?f:null,level:1}}}else{this.locked.level++}},unlock:function(){if(this.locked){if(!--this.locked.level){var d=this.locked.update,e=d&&new a(this.editor,true);this.locked=null;if(d&&!d.equalsContent(e)){this.update()}}}}}})();